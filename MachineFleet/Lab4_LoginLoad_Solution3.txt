#define _CRT_SECURE_NO_WARNINGS
#include<stdio.h>
#include<stdlib.h>
#include<string.h>

typedef struct
{
	long bookNum;
	char title[30];
	char author[25];
	double price;
}bookT;

//Display the contents of the library
void displayAll(bookT* dB, int size);

//Search for an individual book in the library
void searchBook(bookT* dB, int size);

//Add a single book to the library
void addBook(bookT* dB, int size);

//Edit an individual book in the library
void editBook(bookT* dB, int size);

//Save the contents of the library to the backup file
void saveBook(bookT* dB, int size);

//Initialise the library from a file
void loadBook(bookT** dB, int* size);


void main()
{
	int numBooks;
	int i;
	bookT* myLib;
	FILE* fp;
	int option, option2;
	char password[30];
	char sysPassword[30];
	int mode = 0; // 0 means you are a guest 1 means you are an admin

	//Decide if the user has admin or guest rights...
	do
	{
		printf("Please enter a 1 to be an Admin or 2 to be a guest\n");
		scanf("%d", &option);
	} while (option != 1 && option != 2);

	if (option == 1)
	{
		fp = fopen("login.txt", "r");

		if (fp == NULL)
		{
			printf("Not able to check the password so proceeding with the guest option\n");
			loadBook(&myLib, &numBooks);
		}
		else
		{
			//Read system password from the file...
			fscanf(fp, "%s", sysPassword);

			//Read user password
			printf("Please enter the password\n");
			scanf("%s", password);
			
			//Compare the password
			if(strcmp(sysPassword, password)==0)
			{
				mode = 1;

				do
				{
					printf("Please enter the 1 to create a new database or 2 to load the previous library\n");
					scanf("%d", &option2);
				} while (option != 1 && option != 2);

				if (option == 1)
				{
					printf("Please enter the number of books in the library\n");
					scanf("%d", &numBooks);

					myLib = (bookT*)malloc(numBooks * sizeof(bookT));

					for (i = 0;i < numBooks;i++)
					{
						(myLib + i)->bookNum = 0;
						(myLib + i)->price = 0;
						strcpy((myLib + i)->author, "Empty");
						strcpy((myLib + i)->title, "Empty");
					}
				}
				else
				{
					loadBook(&myLib, &numBooks);
				}
			}
			else
			{

				loadBook(&myLib, &numBooks);
			}

		}
	}

	else
	{
		//The guest only gets to load a previous backup library
		loadBook(&myLib, &numBooks);
	}




	//Menu for interacting with the library array.....
	printf("Please enter 1 to Search for a book\n");
	printf("Please enter 2 to Add One book\n");
	printf("Please enter 3 to Save the Library to file\n");
	if (mode == 1)
	{
		printf("Please enter 4 to Edit a book\n");
	}
	printf("Please enter -1 to Exit\n");
	scanf("%d", &option);

	while (option != -1)
	{
		if (option == 1)
		{
			searchBook(myLib, numBooks);
		}

		else if (option == 2)
		{
			addBook(myLib, numBooks);
		}

		else if (option == 3)
		{
			saveBook(myLib, numBooks);
		}
		else if (option == 4 && mode==1)
		{
			editBook(myLib, numBooks);
		}
		else if (option == 4 && mode == 0)
		{
			printf("The guest can not complete the edit option\n");
		}




		printf("Please enter 1 to Search for a book\n");
		printf("Please enter 2 to Add One book\n");
		printf("Please enter 3 to Save the Library to file\n");
		if (mode == 1)
		{
			printf("Please enter 4 to Edit a book\n");
		}
		scanf("%d", &option);
	}

	saveBook(myLib, numBooks);
	free(myLib);
}


void displayAll(bookT* dB, int size)
{
	int i;


	printf("dB is %d and size is %d\n", dB, size);
	for (i = 0;i < size;i++)
	{
		printf("%ld %s %s %lf\n", (dB + i)->bookNum, (dB + i)->title, (dB + i)->author, (dB + i)->price);
	}
}

void searchBook(bookT* dB, int size)
{
	int i;
	long searchNum;
	int found = 0;

	printf("Please enter the book number you are looking for\n");
	scanf("%ld", &searchNum);

	for (i = 0;i < size;i++)
	{
		if ((dB + i)->bookNum == searchNum)
		{
			printf("Book Number %ld\n", (dB + i)->bookNum);
			printf("Title %s\n", (dB + i)->title);
			printf("Author %s\n", (dB + i)->author);
			printf("The price is %lf\n", (dB + i)->price);
			i = size;
			found = 1;

		}

	}

	
	if (found == 0)
		printf("The book can not be found\n");


}


void addBook(bookT* dB, int size)
{
	int i;

	for (i = 0;i < size;i++)
	{
		if ((dB + i)->bookNum == 0)
		{
			printf("Please enter the book number, title, author and price\n");
			
			scanf("%ld %s %s %lf", &(dB + i)->bookNum, (dB + i)->title, (dB + i)->author, &(dB + i)->price);
			return;
		}
	}

	printf("Can not add another book as the array is full\n");

}


void editBook(bookT* dB, int size)
{
	int i;
	long searchNum;
	int found = 0;

	printf("Please enter the book number you are looking to edit\n");
	scanf("%ld", &searchNum);

	for (i = 0;i < size;i++)
	{
		if ((dB + i)->bookNum == searchNum)
		{
			printf("Enter the new price\n");
			scanf("%lf", &(dB + i)->price);

			i = size;
			found = 1;

		}

	}

	if (found == 0)
		printf("The book can not be found\n");

}

void saveBook(bookT* dB, int size)
{
	FILE* fp;
	int i;

	fp = fopen("backUp.txt", "w");

	if (fp == NULL)
	{
		printf("The back up file could not be opened\n");
	}

	else
	{
		fprintf(fp, "%d\n", size);


		for (i = 0;i < size;i++)
		{
			fprintf(fp,"%ld %s %s %lf\n", (dB + i)->bookNum, (dB + i)->title, (dB + i)->author, (dB + i)->price);
		}

		fclose(fp);
	
	}

}


void loadBook(bookT** dB, int* size)
{
	FILE* fp;
	int i;

	fp = fopen("backUp.txt", "r");

	if (fp == NULL)
	{
		printf("The file could not be opened\n");
		
	}

	else
	{
		fscanf(fp, "%d", size);

		*dB = (bookT*)malloc(*size * sizeof(bookT));

		for (i = 0;i < *size;i++)
		{
			fscanf(fp, "%ld %s %s %lf", &(*dB + i)->bookNum, (*dB + i)->title, (*dB + i)->author, &(*dB + i)->price);
		}

		
	}
}